apiVersion: apps/v1
kind: Deployment
metadata:
  name: wallet-demo-keycloak
  labels:
    app: wallet-demo
    app.kubernetes.io/component: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wallet-demo
      app.kubernetes.io/component: keycloak
  template:
    metadata:
      labels:
        app: wallet-demo
        app.kubernetes.io/component: keycloak
    spec:
      serviceAccountName: default
      containers:
        - name: keycloak
          image: "{{ required "keycloak.image.repository is required" .Values.keycloak.image.repository }}:{{ required "keycloak.image.tag is required" .Values.keycloak.image.tag }}"
          imagePullPolicy: IfNotPresent
          args:
            - start-dev
            - --import-realm
            - --http-enabled=true
            - --features=oid4vc-vci
            - --http-relative-path=/auth
            - --hostname={{ printf "https://%s/auth" (required "keycloak.publicHost is required" .Values.keycloak.publicHost) }}
            - --proxy-headers=xforwarded
            - --hostname-strict=true
          env:
            - name: KEYCLOAK_ADMIN
              value: "admin"
            - name: KEYCLOAK_ADMIN_PASSWORD
              value: "admin"
            - name: KC_HEALTH_ENABLED
              value: "true"
          ports:
            - containerPort: 8080
              name: http
          readinessProbe:
            httpGet:
              path: /auth/realms/master
              port: http
            initialDelaySeconds: 20
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /auth/realms/master
              port: http
            initialDelaySeconds: 30
            periodSeconds: 20
          resources:
            requests:
              cpu: 200m
              memory: 1Gi
            limits:
              cpu: "1"
              memory: 2Gi
          volumeMounts:
            - name: keycloak-data
              mountPath: /opt/keycloak/data
            - name: realm-import
              mountPath: /opt/keycloak/data/import/realm-export.json
              subPath: realm-export.json
      volumes:
        - name: keycloak-data
          emptyDir: {}
        - name: realm-import
          secret:
            secretName: wallet-demo-realm
